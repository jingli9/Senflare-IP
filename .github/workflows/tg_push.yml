name: Telegram Push File

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  push_to_tg:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½æ–‡ä»¶
        run: curl -L -o Senflare-Pro.txt https://raw.githubusercontent.com/yifangip/Senflare-IP/refs/heads/main/Senflare-Pro.txt

      - name: æ¨é€ Telegramï¼ˆä»…æ–‡ä»¶æ›´æ–°æ—¶ï¼‰
        run: |
          NEW_HASH=$(sha256sum Senflare-Pro.txt | awk '{print $1}')
          OLD_HASH=$(cat .last_version.txt 2>/dev/null || echo "")
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            # æ—¶é—´æˆ³æ–‡ä»¶å
            TIME_STR=$(date -d "+8 hour" '+%Y-%m-%d_%H-%M')
            READABLE_TIME=$(date -d "+8 hour" '+%Y-%m-%d %H:%M')
            NEW_NAME="${TIME_STR}_ä¼˜é€‰ip.txt"
            mv Senflare-Pro.txt "$NEW_NAME"

            # IP æ•°é‡
            IP_COUNT=$(wc -l < "$NEW_NAME" | tr -d ' ')

            # Telegram æ¨é€ï¼ˆå•è¡Œ captionï¼Œé¿å… YAML æŠ¥é”™ï¼‰
            curl -F document=@"$NEW_NAME" -F caption="ğŸ“¦ Senflare ä¼˜é€‰IPæ›´æ–°é€šçŸ¥ ğŸ•“ æ›´æ–°æ—¶é—´ï¼š$READABLE_TIME ğŸ“Š IPæ•°é‡ï¼š$IP_COUNT ä¸ª ğŸ§¾ æ–‡ä»¶åï¼š$NEW_NAME" "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendDocument?chat_id=${{ secrets.TG_CHAT_ID }}"

            # ä¿å­˜å“ˆå¸Œ
            sha256sum "$NEW_NAME" | awk '{print $1}' > .last_version.txt
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .last_version.txt
            git commit -m "update last_version.txt (auto)" || true
            git push || true
          else
            echo "æ–‡ä»¶æœªæ›´æ–°ï¼Œä¸æ¨é€"
          fi
